<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>LabA</title>
    <link rel="stylesheet" href="../static/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/styles.css">
    <!--<script src="{{ url_for('static', filename='js/script.js') }}" defer></script>-->

</head>
<body class="container mt-4">
    {% if not solo_pdf %}
        {% include "header.html" %}
        
        <form method="POST" class="mb-3 parametros">
            <!-- Row: three horizontal blocks -->
            <div class="row g-3">
                <!-- Bloque 1: sedes -->
                <div class="col-12 col-md-4">
                    <p>Seleccionar sedes:</p>
                    {% for sede in sedes %}
                        <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="sedes"
                                value="{{ sede }}"
                                {% if sede in sedes_seleccionadas %}checked{% endif %}>
                        {{ sede }}
                        </label>
                    {% endfor %}
                </div>

                <!-- Bloque 2: fechas -->
                <div class="col-12 col-md-4">
                    <p>Margen de tiempo:</p>
                    <div class="d-flex flex-column">
                        <label>Desde:</label>
                        <input type="date"
                            name="filtro_fecha_desde"
                            value="{{ filtro_fecha_desde }}"
                            class="form-control w-auto fecha">
                        <label>Hasta:</label>
                        <input type="date"
                            name="filtro_fecha_hasta"
                            value="{{ filtro_fecha_hasta }}"
                            class="form-control w-auto fecha">
                    </div>
                </div>

                <!-- Bloque 3: opcionales -->
                <div class="col-12 col-md-4">
                    <p>Opcionales:</p>
                    <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="herramientas" value="herramientas"
                            {% if mostrar_herramientas %}checked{% endif %}>
                        Mostrar tabla de herramientas
                    </label>
                    <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="graficas" value="graficas"
                            {% if mostrar_graficas %}checked{% endif %}>
                        Mostrar gráficas comparativas
                    </label>
                </div>
            </div>

            <!-- Buttons row: right aligned -->
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="submit" class="btn btn-primary">Aplicar</button>
                <button type="submit"
                        formaction="{{ url_for('estadisticas_pdf') }}"
                        formmethod="post"
                        target="_blank"
                        class="btn btn-success">
                Exportar a PDF
                </button>
            </div>
            </form>




        <!-- <form method="POST" class="mb-3">
            <p>Seleccionar sedes:</p>
            {% for sede in sedes %}
                <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="sedes"
                        value="{{ sede }}"
                        {% if sede in sedes_seleccionadas %}checked{% endif %}>
                    {{ sede }}
                </label>
            {% endfor %}

            <p>Margen de tiempo:</p>
            <div class="d-flex flex-column mb-2">
                <label>Desde:</label>
                <input type="date" name="filtro_fecha_desde" value="{{ filtro_fecha_desde }}" class="form-control w-auto d-inline-block fecha">
                <label>Hasta:</label>
                <input type="date" name="filtro_fecha_hasta" value="{{ filtro_fecha_hasta }}" class="form-control w-auto d-inline-block fecha">
            </div>

            <p>Opcionales:</p>
            <label class="form-check">
                <input class="form-check-input" type="checkbox" name="herramientas" value="herramientas"
                    {% if mostrar_herramientas %}checked{% endif %}>
                    Mostrar tabla de herramientas
            </label>
            <label class="form-check">
                <input class="form-check-input" type="checkbox" name="graficas" value="graficas"
                    {% if mostrar_graficas %}checked{% endif %}>
                    Mostrar gráficas comparativas
            </label>

            <button type="submit" class="btn btn-primary mt-2">Aplicar</button>
        -->
    {% endif %}

    <!-- Tablas que se imprimen en pdf -->
    <div id="tablas-pdf">
        <h1 class="hache1">
            Estadísticas LabA
        </h1>

        <h2 class="h5 mb-4">
            Datos mostrados para:
            {% if sedes_seleccionadas and sedes_seleccionadas|length > 0 %}
                {{ sedes_seleccionadas|join(", ") }}
            {% else %}
                Todas las sedes
            {% endif %}
        </h2>
        <h2 class="h5 mb-4">
            Rango de fechas:
            {% if filtro_fecha_desde %}
                Desde {{ filtro_fecha_desde }}
            {% else %}
                sin límite inferior
            {% endif %}
            {% if filtro_fecha_hasta %}
                hasta {{ filtro_fecha_hasta }}
            {% else %}
                sin límite superior
            {% endif %}
        </h2>
        <h2 class="h5">Uso de equipamiento</h2>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <tr>
                <th>Cantidad de proyectos</th>
                <td>{{ resumen_uso[0] }}</td>
                <th>Cantidad de prototipos</th>
                <td>{{ resumen_uso[1] }}</td>
                <th>Tiempo total (hs)</th>
                <td>{{ resumen_uso[2] }}</td>
            </tr>
        </table>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Cargo</th>
                    <th>Proyecto</th>
                    <th>Herramienta</th>
                    <th>Material</th>
                    <th>Cantidad de prototipos</th>
                    <th>Fecha de necesidad</th>
                    <th>Tiempo estimado (hs)</th>
                    <th>Origen</th>
                </tr>
            </thead>
            <tbody>
                {% for fila in uso_equipamiento %}
                <tr>
                    {% for cell in fila %}
                    <td>{{ cell|default_dash }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>


        <!-- Tabla: Asistencia técnica -->
        <h2 class="h5">Asistencia técnica</h2>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <tr>
                <th>Cantidad de proyectos</th>
                <td>{{ resumen_tecnica[0] }}</td>
                <th>Cantidad de prototipos</th>
                <td>{{ resumen_tecnica[1] }}</td>
                <th>Tiempo total (hs)</th>
                <td>{{ resumen_tecnica[2] }}</td>
            </tr>
        </table>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Proyecto</th>
                    <th>Tiempo estimado (hs)</th>
                    <th>Descripción</th>
                    <th>Cargo</th>
                    <th>Fecha de necesidad</th>
                </tr>
            </thead>
            <tbody>
                {% for fila in asistencia_tecnica %}
                <tr>
                    {% for cell in fila %}
                    <td>{{ cell|default_dash }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Tabla: Asistencia en desarrollo -->
        <h2 class="h5">Asistencia en desarrollo de producto</h2>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <tr>
                <th>Cantidad de proyectos</th>
                <td>{{ resumen_desarrollo[0] }}</td>
                <th>Cantidad de prototipos</th>
                <td>{{ resumen_desarrollo[1] }}</td>
                <th>Tiempo total (hs)</th>
                <td>{{ resumen_desarrollo[2] }}</td>
            </tr>
        </table>

        <table class="table table-striped table-bordered mt-4 mb-4">
            <thead class="table-dark">
                <tr>
                    <th>Proyecto</th>
                    <th>Cantidad de prototipos</th>
                    <th>Herramienta</th>
                    <th>Tiempo estimado (hs)</th>
                    <th>Material</th>
                    <th>Origen material</th>
                    <th>Cargo</th>
                    <th>Fecha de necesidad</th>
                </tr>
            </thead>
            <tbody>
                {% for fila in asistencia_desarrollo %}
                <tr>
                    {% for cell in fila %}
                    <td>{{ cell|default_dash }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Tabla de herramientas -->
        {% if mostrar_herramientas %}
            <h2 class="h5">Resumen por herramienta</h2>
            <table class="table table-striped table-bordered mt-4 mb-4">
                <thead class="table-dark">
                    <tr>
                        <th>Herramienta</th>
                        <th>Tiempo total (hs)</th>
                        <th>Total prototipos</th>
                        <th>Total proyectos</th>
                    </tr>
                </thead>
                <tbody>
                    {% for fila in herramientas_summary %}
                        {% if fila[0] != "nan" %}
                            <tr>
                                <td>{{ fila[0] }}</td>
                                <td>{{ fila[1] }}</td>
                                <td>{{ fila[2] }}</td>
                                <td>{{ fila[3] }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}

        <!-- Tabla de gr'aficas -->

        {% if mostrar_graficas %}
            {% if not solo_pdf %}
                <h2 class="h5">Comparativa entre sedes</h2>
                <canvas id="graficaSedes" width="800" height="400"></canvas>

                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                <script>
                    const ctx = document.getElementById('graficaSedes').getContext('2d');
                    const data = {
                        labels: [{% for fila in graficas_data %}"{{ fila[0] }}",{% endfor %}],
                        datasets: [
                            {
                                label: 'Total proyectos(todos los tipos)',
                                data: [{% for fila in graficas_data %}{{ fila[1] }},{% endfor %}],
                                backgroundColor: 'rgba(255, 99, 132, 0.6)'
                            },
                            {
                                label: 'Total prototipos fabricados',
                                data: [{% for fila in graficas_data %}{{ fila[2] }},{% endfor %}],
                                backgroundColor: 'rgba(54, 162, 235, 0.6)'
                            },
                            {
                                label: 'Tiempo total (hs)',
                                data: [{% for fila in graficas_data %}{{ fila[3] }},{% endfor %}],
                                backgroundColor: 'rgba(75, 192, 192, 0.6)'
                            },
                            {
                                label: 'Proy. Uso de equipamiento',
                                data: [{% for fila in graficas_data %}{{ fila[4] }},{% endfor %}],
                                backgroundColor: 'rgba(255, 206, 86, 0.6)'
                            },
                            {
                                label: 'Proy. Asistencia técnica',
                                data: [{% for fila in graficas_data %}{{ fila[5] }},{% endfor %}],
                                backgroundColor: 'rgba(153, 102, 255, 0.6)'
                            },
                            {
                                label: 'Proy. Asistencia en desarrollo',
                                data: [{% for fila in graficas_data %}{{ fila[6] }},{% endfor %}],
                                backgroundColor: 'rgba(255, 159, 64, 0.6)'
                            },
                            {
                                label: 'Tiempo Proy. Uso de equipamiento (hs)',
                                data: [{% for fila in graficas_data %}{{ fila[7] }},{% endfor %}],
                                backgroundColor: 'rgba(201, 203, 207, 0.6)'
                            },
                            {
                                label: 'Tiempo Proy. Asistencia técnica (hs)',
                                data: [{% for fila in graficas_data %}{{ fila[8] }},{% endfor %}],
                                backgroundColor: 'rgba(0, 128, 0, 0.6)'
                            },
                            {
                                label: 'Tiempo Proy. Asistencia en desarrollo (hs)',
                                data: [{% for fila in graficas_data %}{{ fila[9] }},{% endfor %}],
                                backgroundColor: 'rgba(255, 0, 255, 0.6)'
                            }
                        ]
                    };

                    new Chart(ctx, {
                        type: 'bar',
                        data: data,
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: false, text: 'Comparativa entre sedes' }
                            }
                        }
                    });
                </script>
            {% else %}
                <!-- En PDF mostramos la imagen exportada -->
                 {% if grafica_img %}
                    <img src="{{ grafica_img }}" alt="Gráfico comparativo" style="max-width:100%; height:auto;">
                {% else %}
                    <p>No se pudo exportar la gráfica.</p>
                {% endif %}
            {% endif %}
        {% endif %}


    </div>



    <script src="../static/js/script.js"></script>
</body>
</html>